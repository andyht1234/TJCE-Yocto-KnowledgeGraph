* [layerindex-web][PATCH 0/2] Allow per LayerBranch update disable
@ 2023-10-17  0:54 Tim Orling
  2023-10-17  0:54 ` [layerindex-web][PATCH 1/2] models.py: add updates_enabled to LayerBranch Tim Orling
  2023-10-17  0:54 ` [layerindex-web][PATCH 2/2] update.py: skip unless layerbranch.updates_enabled Tim Orling
  0 siblings, 2 replies; 3+ messages in thread
From: Tim Orling @ 2023-10-17  0:54 UTC (permalink / raw)
  To: yocto; +Cc: Tim Orling

Some layers have branches which match the stable release branch names, but
fail to update for some reason. Rather than completely disable updates for
a LayerItem, allow for a LayerBranch to have updates disabled.

Before this change, we only had the option to completely disable updates for
a layer (Change from "Published" to "No Update" state) or completely disable a
Branch for all layers. These hammers are too heavy and needed a little nuance.

Tim Orling (2):
  models.py: add updates_enabled to LayerBranch
  update.py: skip unless layerbranch.updates_enabled

 .../0047_layerbranch_updates_enabled.py        | 18 ++++++++++++++++++
 layerindex/models.py                           |  2 +-
 layerindex/update.py                           |  5 +++++
 3 files changed, 24 insertions(+), 1 deletion(-)
 create mode 100644 layerindex/migrations/0047_layerbranch_updates_enabled.py

-- 
2.34.1



^ permalink raw reply	[flat|nested] 3+ messages in thread
* [layerindex-web][PATCH 1/2] models.py: add updates_enabled to LayerBranch
  2023-10-17  0:54 [layerindex-web][PATCH 0/2] Allow per LayerBranch update disable Tim Orling
@ 2023-10-17  0:54 ` Tim Orling
  2023-10-17  0:54 ` [layerindex-web][PATCH 2/2] update.py: skip unless layerbranch.updates_enabled Tim Orling
  1 sibling, 0 replies; 3+ messages in thread
From: Tim Orling @ 2023-10-17  0:54 UTC (permalink / raw)
  To: yocto; +Cc: Tim Orling

Especially since LTS branches have become more popular as the
only active branch, we need to be able to turn off updates on
a LayerBranch basis rather than the current Layer or Branch
heavier hammers.

Signed-off-by: Tim Orling <tim.orling@konsulko.com>
---
 .../0047_layerbranch_updates_enabled.py        | 18 ++++++++++++++++++
 layerindex/models.py                           |  2 +-
 2 files changed, 19 insertions(+), 1 deletion(-)
 create mode 100644 layerindex/migrations/0047_layerbranch_updates_enabled.py

diff --git a/layerindex/migrations/0047_layerbranch_updates_enabled.py b/layerindex/migrations/0047_layerbranch_updates_enabled.py
new file mode 100644
index 0000000..44e07ee
--- /dev/null
+++ b/layerindex/migrations/0047_layerbranch_updates_enabled.py
@@ -0,0 +1,18 @@
+# Generated by Django 4.2.6 on 2023-10-07 19:39
+
+from django.db import migrations, models
+
+
+class Migration(migrations.Migration):
+
+    dependencies = [
+        ('layerindex', '0046_alter_patch_status'),
+    ]
+
+    operations = [
+        migrations.AddField(
+            model_name='layerbranch',
+            name='updates_enabled',
+            field=models.BooleanField(default=True, help_text='Enable automatically updating layer metadata for this layer:branch via the update script', verbose_name='Enable updates'),
+        ),
+    ]
diff --git a/layerindex/models.py b/layerindex/models.py
index 5ae60c3..397425a 100644
--- a/layerindex/models.py
+++ b/layerindex/models.py
@@ -241,7 +241,7 @@ class LayerBranch(models.Model):
     actual_branch = models.CharField('Actual Branch', max_length=80, blank=True, help_text='Name of the actual branch in the repository matching the core branch')
     yp_compatible_version = models.ForeignKey(YPCompatibleVersion, verbose_name='Yocto Project Compatible version', null=True, blank=True, on_delete=models.SET_NULL, help_text='Which version of the Yocto Project Compatible program has this layer been approved for for?')
     local_path = models.CharField(max_length=255, blank=True, help_text='Local subdirectory where layer data can be found')
-
+    updates_enabled = models.BooleanField('Enable updates', default=True, help_text='Enable automatically updating layer metadata for this layer:branch via the update script')
     updated = models.DateTimeField(auto_now=True)
 
     class Meta:
-- 
2.34.1



^ permalink raw reply related	[flat|nested] 3+ messages in thread
* [layerindex-web][PATCH 2/2] update.py: skip unless layerbranch.updates_enabled
  2023-10-17  0:54 [layerindex-web][PATCH 0/2] Allow per LayerBranch update disable Tim Orling
  2023-10-17  0:54 ` [layerindex-web][PATCH 1/2] models.py: add updates_enabled to LayerBranch Tim Orling
@ 2023-10-17  0:54 ` Tim Orling
  1 sibling, 0 replies; 3+ messages in thread
From: Tim Orling @ 2023-10-17  0:54 UTC (permalink / raw)
  To: yocto; +Cc: Tim Orling

If layerbranch.updates_enabled is false, skip the update.

Signed-off-by: Tim Orling <tim.orling@konsulko.com>
---
 layerindex/update.py | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/layerindex/update.py b/layerindex/update.py
index 7de9c0d..e7e5c63 100755
--- a/layerindex/update.py
+++ b/layerindex/update.py
@@ -375,6 +375,11 @@ def main():
                         if layerbranch_source:
                             layerbranch.vcs_subdir = layerbranch_source.vcs_subdir
 
+                    layerbranch_updates_enabled = LayerBranch.objects.filter(layer=layer, branch=branchobj.id, updates_enabled=True)
+                    if not layerbranch_updates_enabled:
+                        logger.info("Skipping update of layer %s  branch %s - updates disabled" % (layer.name, branchname))
+                        continue
+
                     # Collect repo info
                     urldir = layer.get_fetch_dir()
                     repodir = os.path.join(fetchdir, urldir)
-- 
2.34.1



^ permalink raw reply related	[flat|nested] 3+ messages in thread
end of thread, other threads:[~2023-10-17  0:55 UTC | newest]

Thread overview: 3+ messages (download: mbox.gz / follow: Atom feed)
-- links below jump to the message on this page --
2023-10-17  0:54 [layerindex-web][PATCH 0/2] Allow per LayerBranch update disable Tim Orling
2023-10-17  0:54 ` [layerindex-web][PATCH 1/2] models.py: add updates_enabled to LayerBranch Tim Orling
2023-10-17  0:54 ` [layerindex-web][PATCH 2/2] update.py: skip unless layerbranch.updates_enabled Tim Orling

