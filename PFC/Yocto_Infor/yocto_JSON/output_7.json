[
    "* [yocto-autobuilder-helper][PATCH v2] AUH: Add Openembedded auto-update-helper with list of layer to test\n@ 2023-10-20 14:05 David Pierret\n  2023-10-20 14:57 ` [yocto] \" Richard Purdie\n  0 siblings, 1 reply; 2+ messages in thread\nFrom: David Pierret @ 2023-10-20 14:05 UTC (permalink / raw)\n  To: yocto; +Cc: David Pierret\n\n- Add setup and run script openembedded specific\n- Add job config\n\nSigned-off-by: David Pierret <david.pierret@smile.fr>\n---\n config.json          |  6 ++++++\n scripts/run-auh-oe   | 45 ++++++++++++++++++++++++++++++++++++++++++++\n scripts/setup-auh-oe | 34 +++++++++++++++++++++++++++++++++\n 3 files changed, 85 insertions(+)\n create mode 100755 scripts/run-auh-oe\n create mode 100755 scripts/setup-auh-oe\n\ndiff --git a/config.json b/config.json\nindex 3acb710..bbd0aaf 100644\n--- a/config.json\n+++ b/config.json\n@@ -1420,6 +1420,12 @@\n                 \"${SCRIPTSDIR}/setup-auh ${HELPERBUILDDIR}; ${SCRIPTSDIR}/run-auh ${HELPERBUILDDIR} ${WEBPUBLISH_DIR}/pub/auh/\"\n             ]\n         },\n+        \"auh-openembedded\" : {\n+            \"NEEDREPOS\" : [\"poky\", \"meta-openembedded\"],\n+            \"EXTRAPLAINCMDS\" : [\n+                \"${SCRIPTSDIR}/setup-auh-oe ${HELPERBUILDDIR}; ${SCRIPTSDIR}/run-auh-oe ${HELPERBUILDDIR} ${WEBPUBLISH_DIR}/pub/auh/ ${HELPERBUILDDIR}/meta-openembedded ${HELPERBUILDDIR}/meta-openembedded/meta-oe ${HELPERBUILDDIR}/meta-openembedded/meta-python ${HELPERBUILDDIR}/meta-openembedded/meta-perl ${HELPERBUILDDIR}/meta-openembedded/meta-networking ${HELPERBUILDDIR}/meta-openembedded/meta-multimedia ${HELPERBUILDDIR}/meta-openembedded/meta-gnome ${HELPERBUILDDIR}/meta-openembedded/meta-xfce ${HELPERBUILDDIR}/meta-openembedded/meta-filesystems ${HELPERBUILDDIR}/meta-openembedded/meta-initramfs ${HELPERBUILDDIR}/meta-openembedded/meta-webserver \"\n+            ]\n+        },\n         \"a-quick\" : {\n             \"TEMPLATE\" : \"trigger-build\"\n         },\ndiff --git a/scripts/run-auh-oe b/scripts/run-auh-oe\nnew file mode 100755\nindex 0000000..588755a\n--- /dev/null\n+++ b/scripts/run-auh-oe\n@@ -0,0 +1,45 @@\n+#!/bin/bash\n+#\n+# SPDX-License-Identifier: GPL-2.0-only\n+#\n+# Run Auto Upgrade Helper in a directory set up by setup_auh.\n+#\n+# Called with $1 - the directory where the setup was created\n+\n+if [ -z $1 ]; then\n+  echo \"Use: $0 [auh_setup_dir] [publish_dir] [meta_dir] [meta_list]\"\n+  exit 1\n+fi\n+\n+full_dir=$(readlink -e $1)\n+\n+auh_dir=$full_dir/auto-upgrade-helper\n+poky_dir=$full_dir/poky\n+\n+build_dir=$full_dir/build\n+sstate_dir=$full_dir/build/sstate-cache\n+meta_dir=$3\n+meta_list=${@:4}\n+machine_list=\"qemux86 qemux86-64 qemuarm qemumips qemuppc qemux86_musl\"\n+\n+pushd $meta_dir || exit 1\n+\n+# Base the upgrades on meta_openembedded master\n+git fetch origin\n+git checkout -B tmp-auh-upgrades origin/main\n+\n+source $poky_dir/oe-init-build-env $build_dir\n+\n+# build the layer_names variable to me used in the command line\n+layer_names=\"\"\n+for d in $meta_list; do\n+  layer_names+=\" $(basename ${d})\"\n+done\n+\n+$auh_dir/upgrade-helper.py -e --layer-dir ${meta_dir} --layer-names ${layer_names} --layer-machines ${machine_list} -- all\n+\n+if [ -n $2 ]; then\n+  cp -rf $build_dir/upgrade-helper/* $2\n+fi\n+\n+popd\ndiff --git a/scripts/setup-auh-oe b/scripts/setup-auh-oe\nnew file mode 100755\nindex 0000000..ba1a7fb\n--- /dev/null\n+++ b/scripts/setup-auh-oe\n@@ -0,0 +1,34 @@\n+#!/bin/bash\n+#\n+# SPDX-License-Identifier: GPL-2.0-only\n+#\n+# Initialize Auto Upgrade Helper in a directory.\n+#\n+# Called with $1 - the directory to place the setup\n+CONFIG_DIR=`dirname $0`/auh-config\n+\n+if [ -z $1 ]; then\n+  echo \"Use: $0 target_dir\"\n+  exit 1\n+fi\n+\n+mkdir -p $1\n+pushd $1\n+\n+git clone git://git.yoctoproject.org/poky\n+pushd poky\n+git config user.email auh@yoctoproject.org\n+git config user.name \"Auto Upgrade Helper\"\n+popd\n+git clone git://git.openembedded.org/meta-openembedded\n+pushd meta-openembedded\n+git config user.email auh@yoctoproject.org\n+git config user.name \"Auto Upgrade Helper\"\n+popd\n+git clone git://git.yoctoproject.org/auto-upgrade-helper\n+source poky/oe-init-build-env build\n+mkdir -p upgrade-helper\n+popd\n+\n+cp $CONFIG_DIR/upgrade-helper.conf $1/build/upgrade-helper\n+cat $CONFIG_DIR/local.conf.append >> $1/build/conf/local.conf\n-- \n2.39.2\n\n\n\n^ permalink raw reply related\t[flat|nested] 2+ messages in thread",
    "* Re: [yocto] [yocto-autobuilder-helper][PATCH v2] AUH: Add Openembedded auto-update-helper with list of layer to test\n  2023-10-20 14:05 [yocto-autobuilder-helper][PATCH v2] AUH: Add Openembedded auto-update-helper with list of layer to test David Pierret\n@ 2023-10-20 14:57 ` Richard Purdie\n  0 siblings, 0 replies; 2+ messages in thread\nFrom: Richard Purdie @ 2023-10-20 14:57 UTC (permalink / raw)\n  To: David Pierret, yocto; +Cc: Khem Raj\n\nHi David,\n\nThanks for revising this, it is heading in the right direction.\n\nOn Fri, 2023-10-20 at 16:05 +0200, David Pierret wrote:\n> - Add setup and run script openembedded specific\n> - Add job config\n> \n> Signed-off-by: David Pierret <david.pierret@smile.fr>\n> ---\n>  config.json          |  6 ++++++\n>  scripts/run-auh-oe   | 45 ++++++++++++++++++++++++++++++++++++++++++++\n>  scripts/setup-auh-oe | 34 +++++++++++++++++++++++++++++++++\n>  3 files changed, 85 insertions(+)\n>  create mode 100755 scripts/run-auh-oe\n>  create mode 100755 scripts/setup-auh-oe\n> \n> diff --git a/config.json b/config.json\n> index 3acb710..bbd0aaf 100644\n> --- a/config.json\n> +++ b/config.json\n> @@ -1420,6 +1420,12 @@\n>                  \"${SCRIPTSDIR}/setup-auh ${HELPERBUILDDIR}; ${SCRIPTSDIR}/run-auh ${HELPERBUILDDIR} ${WEBPUBLISH_DIR}/pub/auh/\"\n>              ]\n>          },\n> +        \"auh-openembedded\" : {\n\nThis needs to be \"auh-meta-oe\" since \"auh\" is for openembedded-core and\nthis is otherwise going to be confusing.\n\n> +            \"NEEDREPOS\" : [\"poky\", \"meta-openembedded\"],\n> +            \"EXTRAPLAINCMDS\" : [\n> +                \"${SCRIPTSDIR}/setup-auh-oe ${HELPERBUILDDIR}; ${SCRIPTSDIR}/run-auh-oe ${HELPERBUILDDIR} ${WEBPUBLISH_DIR}/pub/auh/ ${HELPERBUILDDIR}/meta-openembedded ${HELPERBUILDDIR}/meta-openembedded/meta-oe ${HELPERBUILDDIR}/meta-openembedded/meta-python ${HELPERBUILDDIR}/meta-openembedded/meta-perl ${HELPERBUILDDIR}/meta-openembedded/meta-networking ${HELPERBUILDDIR}/meta-openembedded/meta-multimedia ${HELPERBUILDDIR}/meta-openembedded/meta-gnome ${HELPERBUILDDIR}/meta-openembedded/meta-xfce ${HELPERBUILDDIR}/meta-openembedded/meta-filesystems ${HELPERBUILDDIR}/meta-openembedded/meta-initramfs ${HELPERBUILDDIR}/meta-openembedded/meta-webserver \"\n> +            ]\n> +        },\n>          \"a-quick\" : {\n>              \"TEMPLATE\" : \"trigger-build\"\n>          },\n\nWould it be better to have one setup-auh/run-auh script and add\n${HELPERTARGET}  as a parameter?\n\nThis should translate to \"auh\" or \"auh-meta-oe\" and the script can then\nhave conditionals in to handle both cases rather than duplicating the\nscript?\n\n> diff --git a/scripts/run-auh-oe b/scripts/run-auh-oe\n> new file mode 100755\n> index 0000000..588755a\n> --- /dev/null\n> +++ b/scripts/run-auh-oe\n\nSimilarly, this should be run-auh-meta-oe.\n\n> @@ -0,0 +1,45 @@\n> +#!/bin/bash\n> +#\n> +# SPDX-License-Identifier: GPL-2.0-only\n> +#\n> +# Run Auto Upgrade Helper in a directory set up by setup_auh.\n> +#\n> +# Called with $1 - the directory where the setup was created\n> +\n> +if [ -z $1 ]; then\n> +  echo \"Use: $0 [auh_setup_dir] [publish_dir] [meta_dir] [meta_list]\"\n> +  exit 1\n> +fi\n> +\n> +full_dir=$(readlink -e $1)\n> +\n> +auh_dir=$full_dir/auto-upgrade-helper\n> +poky_dir=$full_dir/poky\n> +\n> +build_dir=$full_dir/build\n> +sstate_dir=$full_dir/build/sstate-cache\n> +meta_dir=$3\n> +meta_list=${@:4}\n> +machine_list=\"qemux86 qemux86-64 qemuarm qemumips qemuppc qemux86_musl\"\n\nDo we need to vary the machine_list per layer? At present it only seems\nto support one list anyway so I'm not sure this does anything useful?\n\n> +pushd $meta_dir || exit 1\n> +\n> +# Base the upgrades on meta_openembedded master\n> +git fetch origin\n> +git checkout -B tmp-auh-upgrades origin/main\n> +\n> +source $poky_dir/oe-init-build-env $build_dir\n> +\n> +# build the layer_names variable to me used in the command line\n> +layer_names=\"\"\n> +for d in $meta_list; do\n> +  layer_names+=\" $(basename ${d})\"\n> +done\n> +\n> +$auh_dir/upgrade-helper.py -e --layer-dir ${meta_dir} --layer-names ${layer_names} --layer-machines ${machine_list} -- all\n\nWould it be simpler just to iterate, calling upgrade-helper once per\nsub-layer or meta-openembedded?\n\nYou may have considered that in which case I'd just like to understand\nwhy you ended up with this as the preferred way of doing things?\n\nIn some ways a separate report/run may be useful for the way meta-oe\nmaintainers might handle this?\n\n> +\n> +if [ -n $2 ]; then\n> +  cp -rf $build_dir/upgrade-helper/* $2\n> +fi\n> +\n> +popd\n> diff --git a/scripts/setup-auh-oe b/scripts/setup-auh-oe\n> new file mode 100755\n> index 0000000..ba1a7fb\n> --- /dev/null\n> +++ b/scripts/setup-auh-oe\n\nThis naming also needs tweaking.\n\n> @@ -0,0 +1,34 @@\n> +#!/bin/bash\n> +#\n> +# SPDX-License-Identifier: GPL-2.0-only\n> +#\n> +# Initialize Auto Upgrade Helper in a directory.\n> +#\n> +# Called with $1 - the directory to place the setup\n> +CONFIG_DIR=`dirname $0`/auh-config\n> +\n> +if [ -z $1 ]; then\n> +  echo \"Use: $0 target_dir\"\n> +  exit 1\n> +fi\n> +\n> +mkdir -p $1\n> +pushd $1\n> +\n> +git clone git://git.yoctoproject.org/poky\n> +pushd poky\n> +git config user.email auh@yoctoproject.org\n> +git config user.name \"Auto Upgrade Helper\"\n> +popd\n> +git clone git://git.openembedded.org/meta-openembedded\n> +pushd meta-openembedded\n> +git config user.email auh@yoctoproject.org\n> +git config user.name \"Auto Upgrade Helper\"\n> +popd\n> +git clone git://git.yoctoproject.org/auto-upgrade-helper\n> +source poky/oe-init-build-env build\n> +mkdir -p upgrade-helper\n> +popd\n> +\n> +cp $CONFIG_DIR/upgrade-helper.conf $1/build/upgrade-helper\n> +cat $CONFIG_DIR/local.conf.append >> $1/build/conf/local.conf\n\nWould a upgrade-helper.conf per target help and simplfy the script\ndifferences?\n\nCheers,\n\nRichard\n\n\n\n\n^ permalink raw reply\t[flat|nested] 2+ messages in thread",
    "end of thread, other threads:[~2023-10-20 14:57 UTC | newest]\n\nThread overview: 2+ messages (download: mbox.gz / follow: Atom feed)\n-- links below jump to the message on this page --\n2023-10-20 14:05 [yocto-autobuilder-helper][PATCH v2] AUH: Add Openembedded auto-update-helper with list of layer to test David Pierret\n2023-10-20 14:57 ` [yocto] \" Richard Purdie\n"
]