* [yocto] How to build a specified recipe every bitbake
@ 2023-08-11  2:21 Jiliang Cai
  2023-08-11  7:47 ` Ross Burton
  0 siblings, 1 reply; 4+ messages in thread
From: Jiliang Cai @ 2023-08-11  2:21 UTC (permalink / raw)
  To: yocto

I have a recipe abc_1.0.bb. It generates a txt contains all layers git commit
ID into /etc. It is installed into image by IMAGE_INSTALL:append = " abc".

I want to rebuild abc every time I execute bitbake <image>. So I set nostamp to
1 in abc_1.0.bb.

It served my purpose. When I execute bitbake core-image-minimal, abc_1.0 is
always rebuilt, even if it was built last time without any changes.

But, it leads to re-do_rootfs every time, and repackages images in formats such
as tar.

I expect that when the txt generated by abc_1.0 has not changed, do_rootfs
should not be re-executed, what should I do?


^ permalink raw reply	[flat|nested] 4+ messages in thread
* Re: [yocto] How to build a specified recipe every bitbake
  2023-08-11  2:21 [yocto] How to build a specified recipe every bitbake Jiliang Cai
@ 2023-08-11  7:47 ` Ross Burton
  2023-08-12  7:23   ` Jiliang Cai
  0 siblings, 1 reply; 4+ messages in thread
From: Ross Burton @ 2023-08-11  7:47 UTC (permalink / raw)
  To: tyrocjl; +Cc: Yocto-mailing-list

On 11 Aug 2023, at 03:21, Jiliang Cai via lists.yoctoproject.org <tyrocjl=gmail.com@lists.yoctoproject.org> wrote:
> 
> I have a recipe abc_1.0.bb. It generates a txt contains all layers git commit
> ID into /etc. It is installed into image by IMAGE_INSTALL:append = " abc".

If you want a list of layers/SHAs in your image, look at the image-buildinfo class.

> I want to rebuild abc every time I execute bitbake <image>. So I set nostamp to
> 1 in abc_1.0.bb.
> 
> It served my purpose. When I execute bitbake core-image-minimal, abc_1.0 is
> always rebuilt, even if it was built last time without any changes.
> 
> But, it leads to re-do_rootfs every time, and repackages images in formats such
> as tar.
> 
> I expect that when the txt generated by abc_1.0 has not changed, do_rootfs
> should not be re-executed, what should I do?

Of course it does: you explicitly told bitbake that this recipe _must_ be re-run and doesn’t have stamps to identify if it can be reused or not.  Use the image-buildinfo class.

Ross

^ permalink raw reply	[flat|nested] 4+ messages in thread
* Re: How to build a specified recipe every bitbake
  2023-08-11  7:47 ` Ross Burton
@ 2023-08-12  7:23   ` Jiliang Cai
  2023-08-21 10:07     ` [yocto] " Ross Burton
  0 siblings, 1 reply; 4+ messages in thread
From: Jiliang Cai @ 2023-08-12  7:23 UTC (permalink / raw)
  To: yocto

[-- Attachment #1: Type: text/plain, Size: 1947 bytes --]

On Fri, Aug 11, 2023 at 12:47 AM, Ross Burton wrote:

> 
> On 11 Aug 2023, at 03:21, Jiliang Cai via lists.yoctoproject.org
> <tyrocjl=gmail.com@lists.yoctoproject.org> wrote:
> 
>> I have a recipe abc_1.0.bb. It generates a txt contains all layers git
>> commit
>> ID into /etc. It is installed into image by IMAGE_INSTALL:append = " abc".
> 
> 
> If you want a list of layers/SHAs in your image, look at the
> image-buildinfo class.

*I use this bbclass, but it sometimes records inaccurate SHAs.*
For example, when I first bitbake based a dirty layer meta-aaa, the SHA works
as expected, followed by a 'modified'. But when I submitted the meta-aaa
modification and ran bitbake again, nothing happened, and the file /etc/build
was not regenerated.
*Although meta-aaa is already clean at this time, the old SHA and 'modified' are*
*still displayed in the rootfs build file.
*
Is there any good way to solve this problem ？

> 
> 
>> I want to rebuild abc every time I execute bitbake <image>. So I set
>> nostamp to
>> 1 in abc_1.0.bb.
>> 
>> It served my purpose. When I execute bitbake core-image-minimal, abc_1.0
>> is
>> always rebuilt, even if it was built last time without any changes.
>> 
>> But, it leads to re-do_rootfs every time, and repackages images in formats
>> such
>> as tar.
>> 
>> I expect that when the txt generated by abc_1.0 has not changed, do_rootfs
>> 
>> should not be re-executed, what should I do?
> 
> Of course it does: you explicitly told bitbake that this recipe _must_ be
> re-run and doesn’t have stamps to identify if it can be reused or not. Use
> the image-buildinfo class.

I set nostamp to 1 in abc_1.0.bb, also to solve the problem similar to the
above image-buildinfo.bbclass. But this introduces a new problem: it sometimes
leads to unnecessary execution of tasks such as do_rootfs.

*Is there any good way to solve this problem ？*

> 
> Ross

[-- Attachment #2: Type: text/html, Size: 2237 bytes --]

^ permalink raw reply	[flat|nested] 4+ messages in thread
* Re: [yocto] How to build a specified recipe every bitbake
  2023-08-12  7:23   ` Jiliang Cai
@ 2023-08-21 10:07     ` Ross Burton
  0 siblings, 0 replies; 4+ messages in thread
From: Ross Burton @ 2023-08-21 10:07 UTC (permalink / raw)
  To: tyrocjl; +Cc: Yocto-mailing-list

On 12 Aug 2023, at 08:23, Jiliang Cai via lists.yoctoproject.org <tyrocjl=gmail.com@lists.yoctoproject.org> wrote:
> 
> On Fri, Aug 11, 2023 at 12:47 AM, Ross Burton wrote:
> On 11 Aug 2023, at 03:21, Jiliang Cai via lists.yoctoproject.org <tyrocjl=gmail.com@lists.yoctoproject.org> wrote:
> I have a recipe abc_1.0.bb. It generates a txt contains all layers git commit
> ID into /etc. It is installed into image by IMAGE_INSTALL:append = " abc". If you want a list of layers/SHAs in your image, look at the image-buildinfo class. I use this bbclass, but it sometimes records inaccurate SHAs.
> For example, when I first bitbake based a dirty layer meta-aaa, the SHA works
> as expected, followed by a 'modified'. But when I submitted the meta-aaa
> modification and ran bitbake again, nothing happened, and the file /etc/build
> was not regenerated.
> Although meta-aaa is already clean at this time, the old SHA and 'modified' are
> still displayed in the rootfs build file.

I suspect the problem is that you didn’t actually change the content of the files, so the image didn’t rebuild.

I’d call this a by-design quirk: if I was using image-buildinfo I wouldn’t want the image to rebuild just because I fixed a typo in a commit message.

Ross

^ permalink raw reply	[flat|nested] 4+ messages in thread
end of thread, other threads:[~2023-08-21 10:07 UTC | newest]

Thread overview: 4+ messages (download: mbox.gz / follow: Atom feed)
-- links below jump to the message on this page --
2023-08-11  2:21 [yocto] How to build a specified recipe every bitbake Jiliang Cai
2023-08-11  7:47 ` Ross Burton
2023-08-12  7:23   ` Jiliang Cai
2023-08-21 10:07     ` [yocto] " Ross Burton

